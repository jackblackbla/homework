import requests
from bs4 import BeautifulSoup
import sys
from PyQt5.QtWidgets import QApplication, QWidget, QPushButton, QHBoxLayout, QVBoxLayout , QLabel, QLineEdit, QTextEdit
class Stocks:
    def __init__(self, code) :
        self.code = code
        
    def get_code(self, code):
        self.code =code
    
    
    
    def get_market_sum(self):#시가총액
        url = "http://finance.naver.com/item/main.nhn?code=" + self.code
        html = requests.get(url).text
    
        soup = BeautifulSoup(html, "html5lib")
        tags = soup.select("#_market_sum")
        tag = tags[0]
        return tag.text.strip().replace('\n' , '').replace('\t', '')

    def get_sales_revenue(self):#매출액
        url = "http://finance.naver.com/item/main.nhn?code=" + self.code
        html = requests.get(url).text
    
        soup = BeautifulSoup(html, "html5lib")
        tags = soup.select("#content > div.section.cop_analysis > div.sub_section > table > tbody > tr:nth-child(1) > td.last.cell_strong")
        tag = tags[0]
        return int(tag.text.replace(',',''))

    def get_oi(self):#영업이익
        url = "http://finance.naver.com/item/main.nhn?code=" + self.code
        html = requests.get(url).text
    
        soup = BeautifulSoup(html, "html5lib")
        tags = soup.select("#content > div.section.cop_analysis > div.sub_section > table > tbody > tr:nth-child(2) > td.last.cell_strong > em")
        tag = tags[0]
        return int(tag.text.replace(',',''))

    def get_ni(self):#당기순이익
        url = "http://finance.naver.com/item/main.nhn?code=" + self.code
        html = requests.get(url).text
    
        soup = BeautifulSoup(html, "html5lib")
        tags = soup.select("#content > div.section.cop_analysis > div.sub_section > table > tbody > tr:nth-child(3) > td.last.cell_strong")
        tag = tags[0]
        return int(tag.text.replace(',',''))

    def get_bps(self):#bps
        url = "http://finance.naver.com/item/main.nhn?code=" + self.code
        html = requests.get(url).text
    
        soup = BeautifulSoup(html, "html5lib")
        tags = soup.select("#tab_con1 > div:nth-child(5) > table > tbody:nth-child(3) > tr:nth-child(2) > td > em:nth-child(3)")
        tag = tags[0]
        return int(tag.text.replace(',',''))
    
    def get_eps(self):#eps
        url = "http://finance.naver.com/item/main.nhn?code=" + self.code
        html = requests.get(url).text
    
        soup = BeautifulSoup(html, "html5lib")
        tags = soup.select("#_eps")
        tag = tags[0]
        
        return int(tag.text.replace(',',''))

    def get_dividend(self):#배당금
        url = "http://finance.naver.com/item/main.nhn?code=" + self.code
        html = requests.get(url).text
    
        soup = BeautifulSoup(html, "html5lib")
        tags = soup.select("#content > div.section.cop_analysis > div.sub_section > table > tbody > tr:nth-child(14) > td.t_line.cell_strong")
        tag = tags[0]
    
        return int(tag.text.replace(',',''))


class MyApp(QWidget):

    def __init__(self):
        super().__init__()
        self.initUI()

    def initUI(self):
        
        list = []
        def addBtnClicked(self) :
            code = stockLine.text()
            stock = Stocks(code)
            stock_dict = {
            '종목 코드' : stock.get_code() ,
            '시가총액' : stock.get_market_sum() ,
            '매출액' : stock.get_sales_revenue() ,
            '영업이익' : stock.get_oi() , 
            '당기순이익' : stock.get_ni() ,
            'bps' : stock.get_bps() , 
            'eps' : stock.get_eps() , 
            '배당금' : stock.get_dividend(code)
            }
            list = stock_dict.keys()
            a = ''
            for x in list :
                a += str(x) + ' '
            stockList.append(a)
        
        stockLabel = QLabel('종목 코드번호 입력')
        stockLine = QLineEdit()
        stockLine.setMaxLength(6)
        
        stockButton = QPushButton('추가')
        stockList = QTextEdit()
        statusLabel = QLabel('종목 목록 :')

        hbox1 = QHBoxLayout()
        hbox1.addWidget(stockLabel)
        hbox1.addWidget(stockLine)
        hbox1.addWidget(stockButton)

        hbox2 = QHBoxLayout()
        hbox2.addWidget(statusLabel)
        hbox3 = QHBoxLayout()
        hbox3.addWidget(stockList)
        vbox = QVBoxLayout()
        vbox.addLayout(hbox1)
        vbox.addLayout(hbox2)
        vbox.addLayout(hbox3)

        self.setLayout(vbox)
        button = self.sender()
        
        stockButton.clicked.connect(addBtnClicked)
            

        self.setWindowTitle('재무제표 가져오기!')
        self.setGeometry(300, 300, 600, 400)
        self.show()

if __name__ == '__main__':
    app = QApplication(sys.argv)
    ex = MyApp()
    sys.exit(app.exec_())
